version: 2

models:
  - name: lin_verif_nbpt_lgkm_19
    description: "Vérification du nombre de points de comptage et de la longueur totale linéarisée à partir de ceux-ci"
    columns:
      - name: nb_pt
        description: "Nombre de points de comptage"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
      - name: sum_lg_km
        description: "Longueur totale linéarisée en km"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
  - name: lin_verif_nature_19
    description: >
      Vérification des valeurs prise par l'attribut nature. Cherche les valeurs aberrantes (sentier, routes empierree...).
      Ce modèle utilise les données de [`creer_vue_19`](/#!/model/model.test_otv.creer_vue_19).
    columns:
      - name: coment_cpt
        description: "nature de la linéarisation parmi *estimation* ou *linearisation*"
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['estimation', 'linearisation']
                description: "Vérifier que les valeurs de l'attribut nature sont valides"
      - name: nature
        description: "nature bdTopo louche parmi *Sentier*, *Chemin*, *Route empierrée*"
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['Sentier','Chemin', 'Route empierrée'] # passer ça ailleur dans une variable plus tard
                description: "Vérifier que les valeurs de l'attribut nature sont celles attendues, i.e pas les plus communes, mais pas non plus les plus louches (genre *Bac ou liaison maritime*)"
      - name: sum_lg_km
        description: "Longueur totale linéarisée en km"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                max_value: 1
                description: "Vérifier que moins de 1km est en nature inattendue"
      - name: cnt
        description: "Nombre de tronçons concernés par la nature inattendue"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1
                description: "Vérifier que si une nature est inattendue, au moins 1 tronçon est concerné"
  - name: lin_verif_gest_bdtopo_19
    description: >
      Vérification des valeurs du champs gestionaire. 
      Ce modèle référence les valeurs de [`lin_verif_gest_bdtopo_19_n_1`](/#!/model/model.test_otv.lin_verif_gest_bdtopo_19_n_1) 
      et [`lin_verif_gest_bdtopo_compare_19`](/#!/model/model.test_otv.lin_verif_gest_bdtopo_compare_19).
    columns:
      - name: gestionaire
        description: "Valeur BdTopo des gestionnaires"
        data_tests:
          - relationships:
              arguments:
                to: ref('lin_verif_gest_bdtopo_19_n_1')
                field: gestionaire
      - name: id
        description: "Identifiant unique généré automatiquement"
        data_tests:
          - not_null
          - unique
      - name: annee
        description: "Sert principalement pour jointure dans le modele *lin_verif_gest_bdtopo_compare_19*"
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_match_regex:
              arguments:
                regex: '^_\d{4}$'
                description: "Vérifier que l'année est au format _YYYY"
  - name: lin_verif_gest_bdtopo_19_n_1
    description: >
      Ce modèle sert de base à la comparaison des gestionnaires présents dans la bdtopo, 
      en fournissant les gestionnaires de l'année précédente à celle étudiée. 
      Il est basé sur la macro `verifier_gestionnaire_bdtopo_lin` (qui s'appuie sur le modèle 
      [`creer_vue_19`](/#!/model/model.test_otv.creer_vue_19) lui même issu de la macro `creer_vue_dept_annee`) 
      et sert de référence au test de relationship du modèle [`lin_verif_gest_bdtopo_19`](/#!/model/model.test_otv.lin_verif_gest_bdtopo_19).
    columns:
      - name: gestionaire
        description: "Gestionnaire de la voie selon la BDTopo IGN"
      - name: annee
        description: "Année de référence des données (_YYYY)"
      - name: id
        description: "Identifiant unique généré automatiquement"
  - name: lin_verif_dept_limitrophe_19
    description: >
      Ce modèle retourne la liste des départements limitrophes au département 19 (Corrèze),
      en excluant les départements de la région Nouvelle-Aquitaine. Il est utilisé par le modèle [`lin_verif_cptg_limitrophe_19`](/#!/model/model.test_otv.lin_verif_cptg_limitrophe_19)
      pour vérifier les comptages existants. Il utilise les géométries
      des communes et départements pour déterminer la contiguïté spatiale. Ils servent ensuite à vérifier si des comptages
      existent sur ces départements
    columns:
      - name: insee_dep
        description: "Code INSEE à 2 chiffres du département limitrophe au 19, hors Nouvelle-Aquitaine."
        data_tests:
          - not_null
          - unique
          - accepted_values:
              values: ['15', '46', '63']
              description: "Doit contenir uniquement les codes INSEE des départements limitrophes à la Corrèze (hors Nouvelle-Aquitaine), codés sur 2 chiffres."
  - name: lin_verif_cptg_limitrophe_19
    description: >
      Ce modèle permet de vérifier les comptages présents en base de données pour les départements limitrophes à la Corrèze (19) (défini dans [`lin_verif_dept_limitrophe_19`](/#!/model/model.test_otv.lin_verif_dept_limitrophe_19)),
      mais en dehors des départements de la région Nouvelle-Aquitaine

      Sources web complémentaires pour certains départements limitrophes :
        - Cantal (15) : https://www.cantal.fr/comptages/
        - Puy-de-Dôme (63) : https://www.puy-de-dome.fr/routes-deplacements.html ou https://www.puy-de-dome.fr/open-data.html
        - Lot (46) : 
            - Données trafic : https://lot.fr/le-trafic-sur-les-routes-du-lot-en-d-tail
            - Carte 2024 : https://lot.fr/sites/lot.fr/files/trafic_mja-2024.pdf
    columns:
      - name: gid
        description: "Identifiant unique de la ligne dans la vue 'vue_compteur_last_annee_know_tmja_pc_pl'."
      - name: id_comptag
        description: "Identifiant du compteur"
      - name: route
        description: "Nom de la route"
      - name: type_poste
        description: "Type de poste de comptage (permanent, temporaire, ponctuel)."
      - name: annee_tmja
        description: "Année de référence pour la valeur tmja."
      - name: tmja
        description: "Trafic Moyen Journalier Annuel (TMJA)."
      - name: pc_pl
        description: "Pourcentage de Poids Lourds (PL) dans le trafic."
      - name: annee_pc_pl
        description: "Année de référence pour le pourcentage de PL."
      - name: geom
        description: "Géométrie du point de comptage "
      - name: gestionnai
        description: "gestionnaire du point de comptage."
  - name: lin_verif_gest_bdtopo_compare_19
    description: >
      Ce modèle permet une comparaison facilitée des résultats des modèles 
      [`lin_verif_gest_bdtopo_19`](/#!/model/model.test_otv.lin_verif_gest_bdtopo_19) et 
      [`lin_verif_gest_bdtopo_19_n_1`](/#!/model/model.test_otv.lin_verif_gest_bdtopo_19_n_1).
    columns:
      - name: gestionnaire_annee_n
        description: "Gestionnaires présentes dans la BDTopo IGN pour l'année N"
      - name: gestionnaire_annee_2
        description: "Gestionnaires présentes dans la BDTopo IGN pour l'année N-1"